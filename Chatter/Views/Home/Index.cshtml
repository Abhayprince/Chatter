@{
    ViewBag.Title = "Chat";
}
<style type="text/css">
    ul {
        list-style-type: none;
    }

    li {
        border-bottom: 1px solid #ddd;
    }

    .user-link {
        padding: 5px;
        /* border: 1px solid; */
        display: inline-block;
    }

        .user-link:hover {
            text-decoration: none;
        }
</style>
<div class="col-sm-3">
    <h2>Active Users</h2>
    <a role="button" class="btn btn-sm btn-primary disabled" disabled id="display-name">Me</a>
    <ul id="active-users-list">
        <li id="user-li-broadcast">
            <a role="button" class="user-link" title="Broadcast Message (Send to All)" data-name="Broadcast" data-userid="">Broadcast</a>
        </li>
    </ul>
</div>
<div class="col-sm-9">

    <h2 id="selected-user-name">Messages</h2>
    <div class="container">
        @*<input type="text" id="message" />
            <input type="button" id="sendmessage" value="Send" />
            <input type="hidden" id="displayname" />
            <ul id="discussion"></ul>*@

        <ul id="discussions"></ul>
        <div class="form-group">
            <div class="input-group">
                <input type="text" class="form-control" id="message" />
                <button type="button" class="input-group-btn btn btn-success" id="sendmessage">
                    <span class="glyphicon glyphicon-send"></span>
                </button>
            </div>
        </div>
        <input type="hidden" id="displayname" />
        <input type="hidden" id="selected-userid" />
    </div>
</div>
@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            $(document).on('click', '.user-link', function (e) {
                const userName = $('#selected-user-name');
                const btn = $(this);
                userName.text(btn.data('name') || 'Messages');
                $('#selected-userid').val(btn.data('userid') || '');
            });

            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.chatterHub;
            // Create a function that the hub can call back to display messages.
            chat.client.send = function (name, message) {
                // Add the message to the page.
                $('#discussions').append('<li><strong>' + htmlEncode(name)
                    + '</strong>: ' + htmlEncode(message) + '</li>');
            };
            chat.client.hello = (msg) => {
                console.log(`Message from server : ${msg}`)
            }
            chat.client.broadcast = (name, msg) => {
                $('#discussions').append('<li><strong>' + htmlEncode(name)
                    + '</strong>: ' + htmlEncode(msg) + '</li>');
                //saveMessageToStorage(fromUserId, message, toUserId, isBroadcasted = false)
            }

            chat.client.usersList = users => {
                console.log('usersList : ', users);
                setUsersList(users);
            }

            // Get the user name and store it to prepend to messages.
            $('#displayname').val(prompt('Enter your name:', ''));
            $('#display-name').text(`${$('#displayname').val()} (Me)`);
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                chat.server.hello($('#displayname').val());
                $('#sendmessage').click(function () {
                    //// Call the Send method on the hub.
                    //chat.server.send($('#displayname').val(), $('#message').val());
                    //// Clear text box and reset focus for next comment.

                    const selectedUserId = $('#selected-userid').val();
                    const msg = $('#message').val();
                    if (selectedUserId) {
                        chat.server.send(selectedUserId, msg)
                    }
                    else {
                        chat.server.broadcast(msg);
                    }
                    $('#discussions').append('<li><strong>Me</strong>: ' + htmlEncode(msg) + '</li>');
                    $('#message').val('').focus();
                });
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}